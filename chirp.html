<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Chrip</title>
<link href="styles/birdss.css" rel="stylesheet" type="text/css">
</head>
<body>

<h1>ORNITHOLOGICAL BLOGPOEM</h1>
<h2>by <a href="">Elisa Gabbert</a></h2>

<div id="scoreImage">

<p>
Touch or click on the bird to start the piece.
When you see an image of a bird, wait for the next music phrase to be displayed.
When you are finished singing the displayed phrase, touch or click on the box for the next phrase.
</p>


<img id="score" src="scores/01.jpg">

<div id="poemLine"></div>

<div id="buttons">

<button id="previousPhrase" class="off">&lt;</button>
<button id="pitch" class="off">off</button>
<button id="startStop" class="off">off</button>
<button id="reset" class="off">reset</button>
<button id="nextPhrase" class="off">&gt;</button>

</div>

</div>

<script src="scripts/recorder.js"></script>
<script type="text/javascript">

//get access to the buttons as objects
var pitchButton = document.getElementById("pitch");
var resetButton = document.getElementById("reset");
var startStopButton = document.getElementById("startStop");
var previousPhraseButton = document.getElementById("previousPhrase");
var nextPhraseButton = document.getElementById("nextPhrase");
//var textField = document.getElementById("textField")
//var slider = document.getElementById("slider")
var poemLine = document.getElementById("poemLine");
var scoreImage = document.getElementById("score");
//slider.value = 0;
//textField.value = "1.";

// assign what will happen when the buttons are clicked
pitchButton.onclick = clickButton;
resetButton.onclick = reset;
startStopButton.onclick = clickButton;
nextPhraseButton.onclick = nextPhrase;
previousPhraseButton.onclick = previousPhrase;
poemLine.onclick = pauseBetweenPhrases;

scoreImage.addEventListener("click", pauseBetweenPhrases);
scoreImage.src = "scores/Twitter_logo_blue.jpg";


var poemLines = ["Ornithological Blogpoem by Elisa Gabbert (tap to begin)",
                 "You will be woken by the chirping of the birds,",
                 "which is the sound of their egos escaping from their bodies",
                 "in loud and irregular streams.",
                 "They are acupuncture birds;",
                 "where the chirps fall on your eardrums corresponds to where you experience the pain.",
                 "The birds have PhDs.",
                 "They chirp out chapters from their dissertations.",
                 "The birds do not agree that irony is dead.",
                 "One of the birds has tried repeatedly to fall to its death",
                 "but always starts flying at the last second.",
                 "The birds are excessively vain about their wings.",
                 "They have been known to assemble themselves into bridges and other structures.",
                 "An obelisk of feathers.",
                 "Do not feed the birds;",
                 "they are following a strict high-protein diet.",
                 "The birds are control freaks.",
                 "Do not, under any circumstances, try to touch their beaks.",
                 "One of the birds has assumed a leadership role.",
                 "Another bird is plotting to assassinate it.",
                 "Some items have gone missing from the kitchen.",
                 "The birds are capable of eating almost anything but are far too discriminating.",
                 "If you are lucky one morning the birds may chirp selections from your favorite opera.",
                 "The birds are especially fond of Wagner.",
                 "What would you like to hear?",
                 "They have a very long waiting list and are nepotistic.",
                 "Do not be afraid of angering the birds.",
                 "What angers the birds is fear."];

var newScore;

var currentPoemLine = 0;
poemLine.innerHTML = poemLines[currentPoemLine];

var timerID;
var recordingTimeoutID;
var repeat = false;

function goToPhrase(phraseIndex) {
	currentPoemLine = phraseIndex;
	displayScore();
}

function displayScore() {
	if (currentPoemLine >= 1 && currentPoemLine <= 27) {
		if (currentPoemLine < 10) {
			newScore = "scores/0" + currentPoemLine + ".jpg";
		} else {
			newScore = "scores/" + currentPoemLine + ".jpg";
		}
	} else {
		newScore = "scores/Twitter_logo_blue.jpg";
	}
	scoreImage.src = newScore;
	poemLine.innerHTML = poemLines[currentPoemLine];
}

function pauseBetweenPhrases() {
	/*
	if (recording) {
		stopGetAndPostAudio();
		recording = false;
		window.clearTimeout(recordingTimeoutID);
	}
	*/
	poemLine.innerHTML = "";
	newScore = "scores/Twitter_logo_blue.jpg";
	scoreImage.src = newScore;
	repeat = Math.random() < 0.25;
	var randomPause = Math.random() * 1000. + 500.;
	timerID = window.setTimeout(endOfRandomPause, randomPause);
}

function endOfRandomPause() {
	if (!repeat) {
		nextPhrase();
	} else {
		displayScore();
	}
}

function nextPhrase() {
	if (currentPoemLine < poemLines.length - 1) {
		currentPoemLine++;
		/*
		if (currentPoemLine == 0) {
			currentPoemLine += 1;
		} else {
			var goToNextLineProbability = Math.random();
			if (goToNextLineProbability < 0.75) {
				currentPoemLine += 1;
			}
		}
		*/
	} else {
		currentPoemLine = 0;
	};
	goToPhrase(currentPoemLine);
	//startRecordingAudio();
	//recording = true;
	//recordingTimeoutID = window.setTimeout(recordingTimeout, 5000);
}

function previousPhrase() {
	if (currentPoemLine > 0) {
		currentPoemLine--;
	}
	goToPhrase(currentPoemLine);
}

function reset() {
	window.clearTimeout(timerID);
	goToPhrase(0);
}

//a handy function that will work for whichever button is clicked, avoiding code duplication
function clickButton() {
	// this refers to whichever button is clicked
	if (this.id == "nextPhrase") {
		nextPhrase();
	}
	if (this.className == "off") {
		this.className = "on";
		this.innerHTML = "on";
		//cues2Play[this.id] = "on";
	} else {
		this.className = "off";
		this.innerHTML = "off";
		//cues2Play[this.id] = "off";
	}
	// write a new cues.json file
	//updateCues();
}

/*
function recordingTimeout() {
	if (recording) {
		stopGetAndPostAudio();
		recording = false;
	}
}
*/



/*
//OK, here we create the object that represents a button for each line in the poem
//declare and initialize our cues2Play variable
var birdCues = {};
for (var line = 0; line < poemLines.length; line++) {
	birdCues["cue" + line] = "off";
}
birdCues.pitch = 1.;
birdCues.panic = "off";
//alert(birdCues.cue0);
//var cues2Play = { cue0: "off", cue1 : "off", cue2 : "off", pitch : 1. };

//when the page is first loaded, write a new cues.json script with the default values
updateCues();
*/

// ***** Let's see if we can move this to another file down the road...


/*
var AudioContext = (window.AudioContext || window.webkitAudioContext);
var audioCtx = new AudioContext();

var source;
var recorder;
//var recording;
var recordings = [];
var recording = false;

function startUserMedia(stream) {
	source = audioCtx.createMediaStreamSource(stream);
	recorder = new Recorder(source);
}

function getBufferCallback(buffers) {
	//var newSource = audioCtx.createBufferSource();
	var newBuffer = audioCtx.createBuffer(2, buffers[0].length, audioCtx.sampleRate);
	newBuffer.getChannelData(0).set(buffers[0]);
	newBuffer.getChannelData(1).set(buffers[1]);
	recordings.push(newBuffer);
	recorder && recorder.exportWAV(function(blob) {
		postAudio(blob);
    });
}

function startUserMedia() {
	navigator.getUserMedia = (navigator.getUserMedia ||
	        navigator.webkitGetUserMedia ||
	        navigator.mozGetUserMedia ||
	        navigator.msGetUserMedia);

	if (navigator.getUserMedia) {
		navigator.getUserMedia(
		// constraints
		{ video: false, audio: true },
		// successCallback
		startUserMedia,
		// errorCallback
		function(err) {
			console.log("The following error occured: " + err);
		});
	} else {
		console.log("getUserMedia not supported");
	};
}

function postAudio(blob) {
	var xhr;
	
	try{
		// Opera 8.0+, Firefox, Safari
		xhr = new XMLHttpRequest();
	} catch(e) {
		// Internet Explorer Browsers
		try{
			xhr = new ActiveXObject("Msxml2.XMLHTTP");
		} catch(e) {
			try{
				xhr = new ActiveXObject("Microsoft.XMLHTTP");
			} catch(e) {
				// Not supported
				alert("There appears to be a problem with your browser.");
				return false;
			}
		}
	}

	
	xhr.onreadystatechange = function(){
		if (xhr.readyState == 4){
			//alert(xhr.responseText);
			var birdIndex = xhr.responseText.match("Birds(.*)\.wav")[1];
			birdCues["cue" + birdIndex] = "on";
			//alert(birdCues["cue" + birdIndex]);
			updateCues();
			// This is your notification that the file has actually successfully uploaded
			// So this is where you should update your cues.json file to tell audience members to download
		}
	}
	
	var fd = new FormData();
	//alert(blob);
	fd.append("birdAudio", blob, "Birds" + currentPoemLine + ".wav");
	
	xhr.open("POST","BirdRecorder.php",true);
	xhr.send(fd);
	
	recorder.clear();
}

function startRecordingAudio() {
	recorder.record();
}

function stopGetAndPostAudio() {
	recorder.stop();
	recorder.getBuffer(getBufferCallback);
}

function playRandomAudioBuffer() {
	var newSource = audioCtx.createBufferSource();
	var newIndex = Math.floor(Math.random() * recordings.length);
	newSource.buffer = recordings[newIndex];
	newSource.connect(audioCtx.destination);
	newSource.start();
}

// ***** The above should ideally all be in a different file...

*/

//var pitchMultiplier;

/*
function showSliderValue(newValue)
{
	var scaledValue = (newValue / 100.) * 31. + 1.;
	scaledValue = Math.round(scaledValue * 100.)/100.;
	textField.value = scaledValue;
	pitchMultiplier = scaledValue;
}
*/

/*
function updateValue() {
	birdCues.pitch = pitchMultiplier;
	updateCues();
}
*/

/*
function textFieldChangeValue(newValue) {
	slider.value = (newValue - 1.) * (100./31.);
	pitchMultiplier = newValue;
	updateValue();
}
*/


function updateCues(){
	var xhr;
	
	// try a bunch of different versions of the object to support different browsers
	try{
		// Opera 8.0+, Firefox, Safari
		xhr = new XMLHttpRequest();
	} catch(e) {
		// Internet Explorer Browsers
		try{
			xhr = new ActiveXObject("Msxml2.XMLHTTP");
		} catch(e) {
			try{
				xhr = new ActiveXObject("Microsoft.XMLHTTP");
			} catch(e) {
				// Something went wrong
				alert("There appears to be a problem with your browser.");
				return false;
			}
		}
	}
	
	// turn the object into a JSON string
	//var json = JSON.stringify(birdCues);
	var json = JSON.stringify(birdCues);
	// compress it from a "binary string" to 64bit ASCII
	// note how the php file does the inverse
	var encoded = btoa(json);
	
	// note that here we're using "POST" instead of "GET", which is what the index.html file uses
	xhr.open("POST", "Birds.php", true);
	// set the content type
	xhr.setRequestHeader('Content-type','application/x-www-form-urlencoded');
	// prepend "var=" for the php script; see how it parses data it receives based on this prefix
	xhr.send('var=' + encoded);
}



</script>

</body>
</html>