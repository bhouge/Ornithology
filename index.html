<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ornithological Blogpoem</title>
<link href="styles/birdss.css" rel="stylesheet" type="text/css">
</head>
<body>

<h1>ORNITHOLOGICAL BLOGPOEM</h1>
<h2>by Elisa Gabbert</h2>
<p>
</p>
<div id="controlButtons">
<button id="listen" class="off">Listen</button>
<button id="nudge" class="off">Nudge</button>
</div>

<div id="birdButtons">
<button id="birdButton1" onclick="birdButtonClicked(1)" class="off"></button>
<button id="birdButton2" onclick="birdButtonClicked(2)" class="off"></button>
<button id="birdButton3" onclick="birdButtonClicked(3)" class="off"></button>
<button id="birdButton4" onclick="birdButtonClicked(4)" class="off"></button>
<button id="birdButton5" onclick="birdButtonClicked(5)" class="off"></button>
<button id="birdButton6" onclick="birdButtonClicked(6)" class="off"></button>
<button id="birdButton7" onclick="birdButtonClicked(7)" class="off"></button>
<button id="birdButton8" onclick="birdButtonClicked(8)" class="off"></button>
<button id="birdButton9" onclick="birdButtonClicked(9)" class="off"></button>
<button id="birdButton10" onclick="birdButtonClicked(10)" class="off"></button>
<button id="birdButton11" onclick="birdButtonClicked(11)" class="off"></button>
<button id="birdButton12" onclick="birdButtonClicked(12)" class="off"></button>
<button id="birdButton13" onclick="birdButtonClicked(13)" class="off"></button>
<button id="birdButton14" onclick="birdButtonClicked(14)" class="off"></button>
<button id="birdButton15" onclick="birdButtonClicked(15)" class="off"></button>
<button id="birdButton16" onclick="birdButtonClicked(16)" class="off"></button>
<button id="birdButton17" onclick="birdButtonClicked(17)" class="off"></button>
<button id="birdButton18" onclick="birdButtonClicked(18)" class="off"></button>
<button id="birdButton19" onclick="birdButtonClicked(19)" class="off"></button>
<button id="birdButton20" onclick="birdButtonClicked(20)" class="off"></button>
<button id="birdButton21" onclick="birdButtonClicked(21)" class="off"></button>
<button id="birdButton22" onclick="birdButtonClicked(22)" class="off"></button>
<button id="birdButton23" onclick="birdButtonClicked(23)" class="off"></button>
<button id="birdButton24" onclick="birdButtonClicked(24)" class="off"></button>
<button id="birdButton25" onclick="birdButtonClicked(25)" class="off"></button>
<button id="birdButton26" onclick="birdButtonClicked(26)" class="off"></button>
<button id="birdButton27" onclick="birdButtonClicked(27)" class="off"></button>
</div>

<script src="scripts/BufferLoader.js"></script>
<script src="scripts/IntermittentSound.js"></script>

<script type="text/javascript">

var poemLines = [["Ornithological Blogpoem by Elisa Gabbert (tap to begin)", 0., 0],
                 ["You will be woken by the chirping of the birds,", 0.25, 1],
                 ["which is the sound of their egos escaping from their bodies", 0., 1],
                 ["in loud and irregular streams.", 0., 2],
                 ["They are acupuncture birds;", 0.25, 1],
                 ["where the chirps fall on your eardrums corresponds to where you experience the pain.", 0., 2],
                 ["The birds have PhDs.", 0.25, 1],
                 ["They chirp out chapters from their dissertations.", 0., 2],
                 ["The birds do not agree that irony is dead.", 0., 2],
                 ["One of the birds has tried repeatedly to fall to its death", 0., 1],
                 ["but always starts flying at the last second.", 0., 2],
                 ["The birds are excessively vain about their wings.", 0.25, 1],
                 ["They have been known to assemble themselves into bridges and other structures.", 0., 1],
                 ["An obelisk of feathers.", 0., 2],
                 ["Do not feed the birds;", 0.25, 1],
                 ["they are following a strict high-protein diet.", 0., 2],
                 ["The birds are control freaks.", 0.25, 1],
                 ["Do not, under any circumstances, try to touch their beaks.", 0., 2],
                 ["One of the birds has assumed a leadership role.", 0.25, 1],
                 ["Another bird is plotting to assassinate it.", 0., 2],
                 ["Some items have gone missing from the kitchen.", 0.25, 1],
                 ["The birds are capable of eating almost anything but are far too discriminating.", 0., 2],
                 ["If you are lucky one morning the birds may chirp selections from your favorite opera.", 0., 1],
                 ["The birds are especially fond of Wagner.", 0., 1],
                 ["What would you like to hear?", 0., 2],
                 ["They have a very long waiting list and are nepotistic.", 0., 2],
                 ["Do not be afraid of angering the birds.", 0., 1],
                 ["What angers the birds is fear.", 0., 2]];


//var birdButtonArray = [];
for (var i = 1; i <= 27; i++) {
	var buttonName = "birdButton" + i;
	var birdButton = document.getElementById(buttonName);
	birdButton.innerHTML = poemLines[i][0];
	//birdButtonArray.push(birdButton);
}

var intermittentSounds = [];
function birdButtonClicked(i) {
	//alert(intermittentSounds + " is " + intermittentSounds.length + " long.");
	var measureNumber = parseInt(i, 10);
	var bufferIndex = measureNumber;
	switch (measureNumber) {
		case 1:
			//awoken
			/*
			var Bird1 = new IntermittentSound(audioBuffers[0], 0.1, 1.25, 4, 7, 0.35, 0.5, 0.1, 0.2, [1.]);
			Bird1.connect(gainNode);
			Bird1.play();
			intermittentSounds.push(Bird1);
			*/
			break;
		case 2:
			//egos
			var Bird2 = new IntermittentSound(audioBuffers[1], 0.85, 1.2, 4, 6, 0.35, 0.5, 0.1, 0.2, [1.]);
			Bird2.connect(gainNode);
			Bird2.play();
			intermittentSounds.push(Bird2);
			break;
		case 3:
			//streams
			var Bird3 = new IntermittentSound(audioBuffers[2], 0.7, 1.1, 3, 5, 0.35, 0.5, 0.1, 0.2, [1.]);
			Bird3.connect(gainNode);
			Bird3.play();
			intermittentSounds.push(Bird3);
			break;
		case 4:
			//acupuncture
			var Bird4 = new IntermittentSound(audioBuffers[3], 0.6, 1., 2, 4, 0.35, 0.5, 0.1, 0.2, [1.]);
			Bird4.connect(gainNode);
			Bird4.play();
			intermittentSounds.push(Bird4);
			break;
		case 5:
			//experience the pain
			var Bird5 = new IntermittentSound(audioBuffers[4], 0.5, 1., 1, 3, 0.35, 0.5, 0.1, 0.2, [1.]);
			Bird5.connect(gainNode);
			Bird5.play();
			intermittentSounds.push(Bird5);
			break;
		case 6:
			//PhD's
			/*
			var Bird6 = new IntermittentSound(audioBuffers[5], 0.1, 1.25, 1, 3, 0.35, 0.5, 0.1, 0.3, [1.]);
			Bird6.connect(gainNode);
			Bird6.play();
			intermittentSounds.push(Bird4);
			*/
			break;
		case 7:
			//dissertations
			var Bird7 = new IntermittentSound(audioBuffers[6], 0.1, 1., 1, 2, 0.35, 0.65, 0.1, 0.3, [1., 4.]);
			Bird7.connect(gainNode);
			Bird7.play();
			intermittentSounds.push(Bird7);
			break;
		case 8:
			/*
			//irony
			var Bird7 = new IntermittentSound(audioBuffers[7], 0.1, 1.25, 1, 3, 0.35, 0.5, 0.1, 0.3, [1.]);
			Bird7.connect(gainNode);
			Bird7.play();
			intermittentSounds.push(Bird7);
			*/
			break;
		case 9:
			//fall to its death
			var Bird7 = new IntermittentSound(audioBuffers[8], 0.1, 1.25, 1, 3, 0.35, 0.5, 0.1, 0.3, [1., 4.]);
			Bird7.connect(gainNode);
			Bird7.play();
			intermittentSounds.push(Bird7);
			break;
		case 10:
			//flying at the last second
			var Bird7 = new IntermittentSound(audioBuffers[9], 0.1, 1.25, 1, 3, 0.35, 0.65, 0.1, 0.5, [1.]);
			Bird7.connect(gainNode);
			Bird7.play();
			intermittentSounds.push(Bird7);
			break;
		case 11:
			//vain about their wings
			var Bird7 = new IntermittentSound(audioBuffers[10], 0.1, 1.25, 1, 3, 0.5, 0.75, 0.1, 1., [1.]);
			Bird7.connect(gainNode);
			Bird7.play();
			intermittentSounds.push(Bird7);
			break;
		case 12:
			//bridges
			var Bird7 = new IntermittentSound(audioBuffers[11], 0.1, 1., 1, 2, 0.5, 0.75, 0.1, 1.5, [1.]);
			Bird7.connect(gainNode);
			Bird7.play();
			intermittentSounds.push(Bird7);
			break;
		case 13:
			//obelisk
			var Bird7 = new IntermittentSound(audioBuffers[12], 0.1, 0.75, 0, 1, 0.5, 0.85, 0.1, 2., [1.]);
			Bird7.connect(gainNode);
			Bird7.play();
			intermittentSounds.push(Bird7);
			break;
		case 14:
			//do not feed
			/*
			var Bird7 = new IntermittentSound(audioBuffers[13], 0.1, 1.25, 1, 3, 0.35, 0.5, 10., 10., [1.]);
			Bird7.connect(gainNode);
			Bird7.play();
			intermittentSounds.push(Bird7);
			*/
			break;
		case 15:
			//high-protein
			var Bird7 = new IntermittentSound(audioBuffers[14], 0.1, 1.25, 2, 5, 0.35, 0.5, 10., 10., [1.]);
			Bird7.connect(gainNode);
			Bird7.play();
			intermittentSounds.push(Bird7);
			break;
		case 16:
			//control freaks
			var Bird7 = new IntermittentSound(audioBuffers[15], 0.1, 1.25, 1, 5, 0.35, 0.5, 10., 10., [1.]);
			Bird7.connect(gainNode);
			Bird7.play();
			intermittentSounds.push(Bird7);
			break;
		case 17:
			//touch their beaks
			var Bird7 = new IntermittentSound(audioBuffers[16], 0.1, 0.75, 1, 4, 0.35, 0.5, 10., 10., [1.]);
			Bird7.connect(gainNode);
			Bird7.play();
			intermittentSounds.push(Bird7);
			break;
		case 18:
			//leadership
			var Bird7 = new IntermittentSound(audioBuffers[17], 0.1, 1.75, 1, 3, 0.35, 0.5, 10., 10., [1.]);
			Bird7.connect(gainNode);
			Bird7.play();
			intermittentSounds.push(Bird7);
			break;
		case 19:
			//assassinate
			var Bird7 = new IntermittentSound(audioBuffers[18], 0.1, 0.75, 0, 1, 0.35, 0.5, 10., 10., [1.]);
			Bird7.connect(gainNode);
			Bird7.play();
			intermittentSounds.push(Bird7);
			break;
		case 20:
			//kitchen
			var Bird7 = new IntermittentSound(audioBuffers[1], 4., 6., 8, 10, 0.05, 0.15, 0.1, 1., [28., 30., 32.]);
			Bird7.connect(gainNode);
			Bird7.play();
			intermittentSounds.push(Bird7);
			break;
		case 21:
			//discriminating
			var Bird7 = new IntermittentSound(audioBuffers[20], 1., 1.25, 0, 2, 0.35, 0.5, 1., 5., [1.]);
			Bird7.connect(gainNode);
			Bird7.play();
			intermittentSounds.push(Bird7);
			var Bird7 = new IntermittentSound(audioBuffers[2], 4., 6., 8, 10, 0.05, 0.25, 0.1, 1., [28., 30., 32.]);
			Bird7.connect(gainNode);
			Bird7.play();
			intermittentSounds.push(Bird7);
			break;
		case 22:
			//opera
			var Bird7 = new IntermittentSound(audioBuffers[21], 1., 1.25, 11, 13, 0.35, 0.5, 0.1, 0.3, [24., 32.]);
			Bird7.connect(gainNode);
			Bird7.play();
			intermittentSounds.push(Bird7);
			var Bird7 = new IntermittentSound(audioBuffers[1], 4., 6., 8, 10, 0.05, 0.15, 1., 5., [28., 30., 32.]);
			Bird7.connect(gainNode);
			Bird7.play();
			intermittentSounds.push(Bird7);
			break;
		case 23:
			//Wagner
			var Bird7 = new IntermittentSound(audioBuffers[22], 1., 1.25, 1, 2, 0.35, 0.5, 1., 2.5, [1.]);
			Bird7.connect(gainNode);
			Bird7.play();
			intermittentSounds.push(Bird7);
			var Bird7 = new IntermittentSound(audioBuffers[2], 4., 6., 5, 15, 0.05, 0.15, 1., 5., [28., 30., 32.]);
			Bird7.connect(gainNode);
			Bird7.play();
			intermittentSounds.push(Bird7);
			break;
		case 24:
			//hear
			var Bird7 = new IntermittentSound(audioBuffers[23], 1., 1.25, 1, 2, 0.35, 0.5, 0.5, 1., [1.]);
			Bird7.connect(gainNode);
			Bird7.play();
			intermittentSounds.push(Bird7);
			var Bird7 = new IntermittentSound(audioBuffers[24], 3., 3., 5, 15, 0.35, 0.5, 2., 6., [16., 24., 32.]);
			Bird7.connect(gainNode);
			Bird7.play();
			intermittentSounds.push(Bird7);
			break;
		case 25:
			//nepotistic
			var Bird7 = new IntermittentSound(audioBuffers[25], 0.5, 0.75, 1, 2, 0.35, 0.5, 0.15, 0.5, [1.]);
			Bird7.connect(gainNode);
			Bird7.play();
			intermittentSounds.push(Bird7);
			var Bird7 = new IntermittentSound(audioBuffers[24], 1.5, 2., 5, 10, 0.35, 0.5, 3., 7., [16., 20., 24., 32.]);
			Bird7.connect(gainNode);
			Bird7.play();
			intermittentSounds.push(Bird7);
			break;
		case 26:
			//anger
			var Bird7 = new IntermittentSound(audioBuffers[26], 0.5, 1., 10, 15, 0.25, 0.5, 4., 10., [12, 16, 32]);
			Bird7.connect(gainNode);
			Bird7.play();
			intermittentSounds.push(Bird7);
			break;
		case 27:
			//fear
			var Bird7 = new IntermittentSound(audioBuffers[26], 0.5, 0.75, 1, 2, 0.15, 0.35, 0.15, 0.5, [1.]);
			Bird7.connect(gainNode);
			Bird7.play();
			intermittentSounds.push(Bird7);
			var Bird7 = new IntermittentSound(audioBuffers[1], 0.5, 1., 8, 10, 0.15, 0.45, 10., 10., [12, 16, 18, 20, 24, 28, 32]);
			Bird7.connect(gainNode);
			Bird7.play();
			intermittentSounds.push(Bird7);
			break;
		default:
			if (bufferIndex > 0) {
				var birdIndex = i;
				//alert(birdIndex);
				var bird = audioCtx.createBufferSource();
				bird.buffer = audioBuffers[bufferIndex];
				bird.connect(gainNode);
				bird.start(audioCtx.currentTime);
			}
			break;
	}
}

// initializing our cues2Play variable
var cues2Play = {};
for (var line = 0; line < poemLines.length; line++) {
	cues2Play["cue" + line] = "off";
}
cues2Play.pitch = 1.;
cues2Play.panic = "off";

// getting references to our buttons from the parent object
var listenButton = document.getElementById("listen");
var nudgeButton = document.getElementById("nudge");

// setting up what functions get called when the buttons are clicked
listenButton.onclick = listenButtonClicked;
nudgeButton.onclick = nudgeButtonClicked;
//window.onclick = nudgeButtonClicked;


// setting up our audio context and creating our master gain
var AudioContext = window.AudioContext || window.webkitAudioContext;
var audioCtx = new AudioContext();

var gainNode = audioCtx.createGain();
gainNode.connect(audioCtx.destination);
gainNode.gain.value = 1.0;

//var soundNode;

var audioBuffers = [];
var buffersAreLoaded = false;

function loadAudioData() {
	var filesToLoad = ["yooo.mp3"];
	for (var i = 1; i <= 27; i++) {
		var fileToLoad = "Birds" + i + ".mp3";
		filesToLoad.push(fileToLoad);
	}
	bufferLoader = new BufferLoader(audioCtx, 
			'sounds/compressed/Ben/',
			filesToLoad, 
			finishedLoading);
	bufferLoader.load();
}


function finishedLoading(bufferList) {
	for (var i = 0; i < bufferList.length; ++i) {
		audioBuffers[i] = bufferList[i];
	}
	buffersAreLoaded = true;
	//alert(audioBuffers);
}

loadAudioData();


function getRandomFileNames(fileList, desiredFileNumber) {
	var randomFiles = [];
	if (fileList.length >= desiredFileNumber) {
		var currentFile;
		while (randomFiles.length < desiredFileNumber) {
			var newFileIndex = Math.floor(Math.random() * fileList.length);
			newFile = fileList[newFileIndex];
			if (randomFiles.indexOf(newFile) < 0) {
				randomFiles.push(newFile);
			}
		}
	} else {
		randomFiles = fileList;
	}
	return randomFiles;
}

//var randomFiles = getRandomFileNames(birdFiles, 3);
//alert(randomFiles);



//set up a different method for this!
var nudgeTimeout = 0;
var birdCounter = 1;
function nudgeButtonClicked(sender) {
	// call getCues with "force" flag set to 1.
	// make it so that tapping anywhere on the screen calls this method
	//alert("nudged!");
	// set timeout for onclick nudge 
	getCues(1);
	/*
	buttonClicked(birdCounter);
	birdCounter++;
	if (birdCounter > 3) {
		birdCounter = 1;
	}
	*/
}

// when the listenButton is clicked, we start start polling for changes in the json file
function listenButtonClicked() {
	if (buffersAreLoaded) {
		var yooo = audioCtx.createBufferSource();
		var yoooGain = audioCtx.createGain();
		yooo.buffer = audioBuffers[0];
		yooo.connect(yoooGain);
		yoooGain.connect(gainNode);
		yoooGain.gain.value = 0.5;
		yooo.start(audioCtx.currentTime);
		if(this.className == "off") {
			this.className = "on";
			this.innerHTML = "Stop Listening";
			getCues(1);
			window.setTimeout(pollForChanges, 1000., false);
		} else {
			this.className = "off";
			this.innerHTML = "Listen";
		}
	}
}

function stopEverything() {
	//alert(intermittentSounds + " is " + intermittentSounds.length + " long.");
	for (var i = 0; i < intermittentSounds.length; i++) {
		//alert("intermittent sound" + i + ": " + intermittentSounds[i]);
		intermittentSounds[i].stop();
	}
}

function pollForChanges(force) {
	getCues(force);
	// You know, I think I didn't have this functionality in Lysias on purpose;
	// Otherwise someone could mess up the piece by turning off listening and turning it back on.
	// Problem could be mitigated by turning buttons off when they're no longer valid,
	// which I didn't do for Lysias.
	if (listenButton.className == "on") {
		window.setTimeout(pollForChanges, 1000., false);
	}
}

function getCues(force) {
	var xhr;
	try{
		// Opera 8.0+, Firefox, Safari
		xhr = new XMLHttpRequest();
	} catch(e) {
		// Internet Explorer Browsers
		try{
			xhr = new ActiveXObject("Msxml2.XMLHTTP");
		} catch(e) {
			try{
				xhr = new ActiveXObject("Microsoft.XMLHTTP");
			} catch(e) {
				alert("Your browser apparently does not support AJAX.");
				return false;
			}
		}
	}
	xhr.onreadystatechange = function() {
		//alert("readyState: " + xhr.readyState + "; status: " + xhr.status);
		if (xhr.readyState == 4) {
			if (xhr.status == 200) {
				try {
					var newCues2Play = JSON.parse(xhr.responseText);
					cues2Play.pitch = newCues2Play.pitch;
					for (var cue in newCues2Play) {
						if (cues2Play[cue] != newCues2Play[cue]) {
							cues2Play[cue] = newCues2Play[cue];
							if (cues2Play[cue] == "on") {
								if (cue.slice(0, 3) == "cue") {
									var cueIndex = cue.slice(3);
									//alert(cueIndex);
									birdButtonClicked(cueIndex);
								} else if (cue == "panic") {
									stopEverything();
								}
							}
						}
					}
					
					/*
					
					// at some point I'll add back some of this functionality, specifically the panic button
					for (var cue in newCues2Play) {
							if (cues2Play[cue] != newCues2Play[cue]) {
								cues2Play[cue] = newCues2Play[cue];
								var cueIndex = cue.slice(3);
								if (cue != "panic") {
									if (cues2Play[cue] == "on") {
										buttonActivated(cueIndex);
									} else {
										buttonDeactivated(cueIndex);
									}
								} else {
									//alert("Start panicking!");
									stopEverything();
								}
							}
						}
					*/
				} catch(e) {
					// Of course we don't want to alert this; we want it to fail unobtrusively,
					// since all it means is that we got a bad json file...
					// however, for testing...
					alert(e);
					var error = e;
				}
			}
		}
	}
	
	if (force) {
		// Adding a time stamp gives it a unique name which should force the browser to really read the json file
		// instead of using a cached version
		var currentTime = new Date();
		var timeStamp = currentTime.getTime();
		xhr.open('GET', 'cues.json?_=' + timeStamp, true);
		xhr.setRequestHeader('Cache-Control', 'no-cache');
	} else {
		xhr.open('GET', 'cues.json', true);
	}

	xhr.overrideMimeType("application/json");
	xhr.send(null);
}

</script>

</body>
</html>