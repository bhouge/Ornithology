<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ornithological Blogpoem</title>
<link href="styles/birdss.css" rel="stylesheet" type="text/css">
</head>
<body>

<h1>ORNITHOLOGICAL BLOGPOEM</h1>
<h2>by Elisa Gabbert</h2>
<p>
</p>
<div id="controlButtons">
<button id="listen" class="off">Listen</button>
<button id="nudge" class="off">Nudge</button>
</div>

<div id="birdButtons">
<button id="birdButton1" onclick="birdButtonClicked(1)" class="off">Nudge</button>
<button id="birdButton2" onclick="birdButtonClicked(2)" class="off">Nudge</button>
<button id="birdButton3" onclick="birdButtonClicked(3)" class="off">Nudge</button>
<button id="birdButton4" onclick="birdButtonClicked(4)" class="off">Nudge</button>
<button id="birdButton5" onclick="birdButtonClicked(5)" class="off">Nudge</button>
<button id="birdButton6" onclick="birdButtonClicked(6)" class="off">Nudge</button>
<button id="birdButton7" onclick="birdButtonClicked(7)" class="off">Nudge</button>
<button id="birdButton8" onclick="birdButtonClicked(8)" class="off">Nudge</button>
<button id="birdButton9" onclick="birdButtonClicked(9)" class="off">Nudge</button>
<button id="birdButton10" onclick="birdButtonClicked(10)" class="off">Nudge</button>
<button id="birdButton11" onclick="birdButtonClicked(11)" class="off">Nudge</button>
<button id="birdButton12" onclick="birdButtonClicked(12)" class="off">Nudge</button>
<button id="birdButton13" onclick="birdButtonClicked(13)" class="off">Nudge</button>
<button id="birdButton14" onclick="birdButtonClicked(14)" class="off">Nudge</button>
<button id="birdButton15" onclick="birdButtonClicked(15)" class="off">Nudge</button>
<button id="birdButton16" onclick="birdButtonClicked(16)" class="off">Nudge</button>
<button id="birdButton17" onclick="birdButtonClicked(17)" class="off">Nudge</button>
<button id="birdButton18" onclick="birdButtonClicked(18)" class="off">Nudge</button>
<button id="birdButton19" onclick="birdButtonClicked(19)" class="off">Nudge</button>
<button id="birdButton20" onclick="birdButtonClicked(20)" class="off">Nudge</button>
<button id="birdButton21" onclick="birdButtonClicked(21)" class="off">Nudge</button>
<button id="birdButton22" onclick="birdButtonClicked(22)" class="off">Nudge</button>
<button id="birdButton23" onclick="birdButtonClicked(23)" class="off">Nudge</button>
<button id="birdButton24" onclick="birdButtonClicked(24)" class="off">Nudge</button>
<button id="birdButton25" onclick="birdButtonClicked(25)" class="off">Nudge</button>
<button id="birdButton26" onclick="birdButtonClicked(26)" class="off">Nudge</button>
<button id="birdButton27" onclick="birdButtonClicked(27)" class="off">Nudge</button>
</div>



<script src="scripts/BufferLoader.js"></script>

<script type="text/javascript">

//var fileList = ['Birds1.wav', "Birds2.wav", "Birds3.wav", "Birds4.wav", "Birds5.wav"];

var poemLines = [["Ornithological Blogpoem by Elisa Gabbert (tap to begin)", 0., 0],
                 ["You will be woken by the chirping of the birds,", 0.25, 1],
                 ["which is the sound of their egos escaping from their bodies", 0., 1],
                 ["in loud and irregular streams.", 0., 2],
                 ["They are acupuncture birds;", 0.25, 1],
                 ["where the chirps fall on your eardrums corresponds to where you experience the pain.", 0., 2],
                 ["The birds have PhDs.", 0.25, 1],
                 ["They chirp out chapters from their dissertations.", 0., 2],
                 ["The birds do not agree that irony is dead.", 0., 2],
                 ["One of the birds has tried repeatedly to fall to its death", 0., 1],
                 ["but always starts flying at the last second.", 0., 2],
                 ["The birds are excessively vain about their wings.", 0.25, 1],
                 ["They have been known to assemble themselves into bridges and other structures.", 0., 1],
                 ["An obelisk of feathers.", 0., 2],
                 ["Do not feed the birds;", 0.25, 1],
                 ["they are following a strict high-protein diet.", 0., 2],
                 ["The birds are control freaks.", 0.25, 1],
                 ["Do not, under any circumstances, try to touch their beaks.", 0., 2],
                 ["One of the birds has assumed a leadership role.", 0.25, 1],
                 ["Another bird is plotting to assassinate it.", 0., 2],
                 ["Some items have gone missing from the kitchen.", 0.25, 1],
                 ["The birds are capable of eating almost anything but are far too discriminating.", 0., 2],
                 ["If you are lucky one morning the birds may chirp selections from your favorite opera.", 0., 1],
                 ["The birds are especially fond of Wagner.", 0., 1],
                 ["What would you like to hear?", 0., 2],
                 ["They have a very long waiting list and are nepotistic.", 0., 2],
                 ["Do not be afraid of angering the birds.", 0., 1],
                 ["What angers the birds is fear.", 0., 2]];


var birdButtonArray = [];
for (var i = 1; i <= 27; i++) {
	var buttonName = "birdButton" + i;
	var birdButton = document.getElementById(buttonName);
	birdButton.innerHTML = poemLines[i][0];
	birdButtonArray.push(birdButton);
}

function birdButtonClicked(i) {
	var birdIndex = i;
	//alert(birdIndex);
	var bird = audioCtx.createBufferSource();
	bird.buffer = audioBuffers[i-1];
	bird.connect(gainNode);
	bird.start(audioCtx.currentTime);
}

// initializing our cues2Play variable
var cues2Play = { "pitch" : 1. };

// getting references to our buttons from the parent object
var listenButton = document.getElementById("listen");
var nudgeButton = document.getElementById("nudge");

// setting up what functions get called when the buttons are clicked
listenButton.onclick = listenButtonClicked;
nudgeButton.onclick = nudgeButtonClicked;
//window.onclick = nudgeButtonClicked;


// setting up our audio context and creating our master gain
var AudioContext = window.AudioContext || window.webkitAudioContext;
var audioCtx = new AudioContext();

var gainNode = audioCtx.createGain();
gainNode.connect(audioCtx.destination);
gainNode.gain.value = 1.0;

//var soundNode;

var audioBuffers = [];
var buffersAreLoaded = false;

function loadAudioData() {
	var filesToLoad = [];
	for (var i = 1; i <= 27; i++) {
		var fileToLoad = "Birds" + i + ".mp3";
		filesToLoad.push(fileToLoad);
	}
	bufferLoader = new BufferLoader(audioCtx, 
			'sounds/compressed/Ben/',
			filesToLoad, 
			finishedLoading);
	bufferLoader.load();
}


function finishedLoading(bufferList) {
	for (var i = 0; i < bufferList.length; ++i) {
		audioBuffers[i] = bufferList[i];
	}
	buffersAreLoaded = true;
	//alert(audioBuffers);
}

loadAudioData();


function getRandomFileNames(fileList, desiredFileNumber) {
	var randomFiles = [];
	if (fileList.length >= desiredFileNumber) {
		var currentFile;
		while (randomFiles.length < desiredFileNumber) {
			var newFileIndex = Math.floor(Math.random() * fileList.length);
			newFile = fileList[newFileIndex];
			if (randomFiles.indexOf(newFile) < 0) {
				randomFiles.push(newFile);
			}
		}
	} else {
		randomFiles = fileList;
	}
	return randomFiles;
}

//var randomFiles = getRandomFileNames(birdFiles, 3);
//alert(randomFiles);



//set up a different method for this!
var nudgeTimeout = 0;
var birdCounter = 1;
function nudgeButtonClicked(sender) {
	// call getCues with "force" flag set to 1.
	// make it so that tapping anywhere on the screen calls this method
	//alert("nudged!");
	// set timeout for onclick nudge 
	getCues(1);
	/*
	buttonClicked(birdCounter);
	birdCounter++;
	if (birdCounter > 3) {
		birdCounter = 1;
	}
	*/
}

// when the listenButton is clicked, we start start polling for changes in the json file
function listenButtonClicked() {
	if(this.className == "off") {
		this.className = "on";
		this.innerHTML = "Stop Listening";
		getCues(1);
		window.setTimeout(pollForChanges, 1000., false);
	} else {
		this.className = "off";
		this.innerHTML = "Listen";
	}
}

function pollForChanges(force) {
	getCues(force);
	// You know, I think I didn't have this functionality in Lysias on purpose;
	// Otherwise someone could mess up the piece by turning off listening and turning it back on.
	// Problem could be mitigated by turning buttons off when they're no longer valid,
	// which I didn't do for Lysias.
	if (listenButton.className == "on") {
		window.setTimeout(pollForChanges, 1000., false);
	}
}

function getCues(force) {
	var xhr;
	try{
		// Opera 8.0+, Firefox, Safari
		xhr = new XMLHttpRequest();
	} catch(e) {
		// Internet Explorer Browsers
		try{
			xhr = new ActiveXObject("Msxml2.XMLHTTP");
		} catch(e) {
			try{
				xhr = new ActiveXObject("Microsoft.XMLHTTP");
			} catch(e) {
				alert("Your browser apparently does not support AJAX.");
				return false;
			}
		}
	}
	xhr.onreadystatechange = function() {
		//alert("readyState: " + xhr.readyState + "; status: " + xhr.status);
		if (xhr.readyState == 4) {
			if (xhr.status == 200) {
				try {
					var newCues2Play = JSON.parse(xhr.responseText);
					cues2Play.pitch = newCues2Play.pitch;
					for (var cue in newCues2Play) {
						if (cue.slice(0, 3) == "cue") {
							if (cues2Play[cue] != newCues2Play[cue]) {
								cues2Play[cue] = newCues2Play[cue];
								if (cues2Play[cue] == "on") {
									var cueIndex = cue.slice(3);
									//alert(cueIndex);
									birdButtonClicked(cueIndex);
								}
							}
						}
					}
					
					/*
					
					// at some point I'll add back some of this functionality, specifically the panic button
					for (var cue in newCues2Play) {
							if (cues2Play[cue] != newCues2Play[cue]) {
								cues2Play[cue] = newCues2Play[cue];
								var cueIndex = cue.slice(3);
								if (cue != "panic") {
									if (cues2Play[cue] == "on") {
										buttonActivated(cueIndex);
									} else {
										buttonDeactivated(cueIndex);
									}
								} else {
									//alert("Start panicking!");
									stopEverything();
								}
							}
						}
					*/
				} catch(e) {
					// Of course we don't want to alert this; we want it to fail unobtrusively,
					// since all it means is that we got a bad json file...
					// however, for testing...
					alert(e);
					var error = e;
				}
			}
		}
	}
	
	if (force) {
		// Adding a time stamp gives it a unique name which should force the browser to really read the json file
		// instead of using a cached version
		var currentTime = new Date();
		var timeStamp = currentTime.getTime();
		xhr.open('GET', 'cues.json?_=' + timeStamp, true);
		xhr.setRequestHeader('Cache-Control', 'no-cache');
	} else {
		xhr.open('GET', 'cues.json', true);
	}

	xhr.overrideMimeType("application/json");
	xhr.send(null);
}

</script>

</body>
</html>